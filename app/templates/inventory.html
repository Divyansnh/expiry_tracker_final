{% extends "base.html" %}

{% block title %}Inventory - Expiry Tracker{% endblock %}

{% block content %}
<!-- Modern Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-8 border-0 w-full max-w-md shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
        <div class="mt-3">
            <div class="flex items-center justify-center w-16 h-16 mx-auto bg-gradient-to-r from-red-100 to-pink-100 rounded-full shadow-lg">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            <div class="mt-6 text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-4" id="deleteModalTitle">Delete Item</h3>
                <div class="mt-4 px-4 py-4">
                    <p class="text-base text-gray-600 mb-4" id="deleteModalMessage">
                        Are you sure you want to delete this item? This action cannot be undone.
                    </p>
                    <div id="deleteModalDetails" class="mt-4 text-left bg-gray-50 p-4 rounded-lg border">
                        <!-- Item details will be populated here -->
                    </div>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="confirmDeleteBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-3 rounded-lg shadow text-base font-semibold hover:from-red-600 hover:to-pink-600 transition">
                        Delete
                    </button>
                    <button onclick="hideDeleteConfirmationModal()" class="bg-gray-100 text-gray-800 px-6 py-3 rounded-lg text-base font-semibold hover:bg-gray-200 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Bulk Delete Confirmation Modal -->
<div id="bulkDeleteConfirmationModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-8 border-0 w-full max-w-2xl shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
        <div class="mt-3">
            <div class="flex items-center justify-center w-16 h-16 mx-auto bg-gradient-to-r from-red-100 to-pink-100 rounded-full shadow-lg">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            <div class="mt-6 text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-4" id="bulkDeleteModalTitle">Delete Multiple Items</h3>
                <div class="mt-4 px-4 py-4">
                    <p class="text-base text-gray-600 mb-4" id="bulkDeleteModalMessage">
                        Are you sure you want to delete the selected items? This action cannot be undone.
                    </p>
                    <div id="bulkDeleteModalDetails" class="mt-4 text-left bg-gray-50 p-4 rounded-lg border max-h-60 overflow-y-auto">
                        <!-- Item details will be populated here -->
                    </div>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="confirmBulkDeleteBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-3 rounded-lg shadow text-base font-semibold hover:from-red-600 hover:to-pink-600 transition">
                        Delete All
                    </button>
                    <button onclick="hideBulkDeleteConfirmationModal()" class="bg-gray-100 text-gray-800 px-6 py-3 rounded-lg text-base font-semibold hover:bg-gray-200 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Success Notification -->
<div id="successNotification" class="hidden fixed top-4 right-4 z-[9999]">
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6 shadow-2xl backdrop-blur-sm">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-green-500 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-base font-semibold text-green-800">Success!</h3>
                <div class="mt-2 text-sm text-green-700">
                    <p id="successMessage">Operation completed successfully.</p>
                </div>
                <div class="mt-4">
                    <button type="button" onclick="hideSuccessNotification()" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-green-600 hover:to-emerald-600 transition">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Error Notification -->
<div id="errorNotification" class="hidden fixed top-4 right-4 z-[9999]">
    <div class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-xl p-6 shadow-2xl backdrop-blur-sm">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-base font-semibold text-red-800">Error</h3>
                <div class="mt-2 text-sm text-red-700">
                    <p id="errorMessage">An error occurred. Please try again.</p>
                </div>
                <div class="mt-4">
                    <button type="button" onclick="hideErrorNotification()" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-red-600 hover:to-pink-600 transition">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Warning Notification -->
<div id="warningNotification" class="hidden fixed top-4 right-4 z-[9999]">
    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-6 shadow-2xl backdrop-blur-sm">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-base font-semibold text-yellow-800">Warning</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <p id="warningMessage">Please check your selection.</p>
                </div>
                <div class="mt-4">
                    <button type="button" onclick="hideWarningNotification()" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-yellow-600 hover:to-orange-600 transition">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Item Update Confirmation Modal -->
<div id="itemUpdateConfirmationModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full z-[60]">
    <div class="relative top-20 mx-auto p-8 border-0 w-full max-w-md shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
        <div class="mt-3">
            <div class="flex items-center justify-center w-16 h-16 mx-auto bg-gradient-to-r from-blue-100 to-purple-100 rounded-full shadow-lg">
                <i class="fas fa-info-circle text-blue-600 text-2xl"></i>
            </div>
            <div class="mt-6 text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-4" id="itemUpdateModalTitle">Item Already Exists</h3>
                <div class="mt-4 px-4 py-4">
                    <p class="text-base text-gray-600 mb-4" id="itemUpdateModalMessage">
                        An item with this name already exists in your inventory.
                    </p>
                    <div id="itemUpdateModalDetails" class="mt-4 text-left bg-gray-50 p-4 rounded-lg border">
                        <!-- Existing item details will be populated here -->
                    </div>
                    <p class="text-base text-gray-600 mt-4">
                        Would you like to update the existing item with the new information?
                    </p>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="confirmUpdateBtn" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg shadow text-base font-semibold hover:from-blue-600 hover:to-purple-600 transition">
                        Update Item
                    </button>
                    <button onclick="hideItemUpdateConfirmationModal()" class="bg-gray-100 text-gray-800 px-6 py-3 rounded-lg text-base font-semibold hover:bg-gray-200 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let isBulkDeleteMode = false;

// Real-time validation and sanitization system
const validators = {
    // Name validation
    name: {
        validate: (value) => {
            if (!value.trim()) return 'Name is required';
            if (value.length > 100) return 'Name must be 100 characters or less';
            // Only allow letters, numbers, and spaces
            if (!/^[a-zA-Z0-9\s]+$/.test(value)) return 'Name can only contain letters, numbers, and spaces';
            return null;
        },
        sanitize: (value) => {
            // Remove HTML tags and any non-alphanumeric characters except spaces
            return value.replace(/<[^>]*>/g, '').replace(/[^a-zA-Z0-9\s]/g, '').trim();
        },
        format: (value) => {
            // Apply title case formatting
            return value.toLowerCase().split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
    },
    
    // Quantity validation
    quantity: {
        validate: (value) => {
            if (!value || value.trim() === '') return 'Quantity is required';
            if (isNaN(value) || parseFloat(value) <= 0) return 'Quantity must be greater than 0';
            if (parseFloat(value) > 999999) return 'Quantity is too large';
            return null;
        },
        sanitize: (value) => {
            // Only sanitize if there's a value, don't auto-fill with 0
            if (!value || value.trim() === '') return '';
            const num = parseFloat(value);
            return isNaN(num) ? '' : num.toFixed(2);
        }
    },
    
    // Unit validation
    unit: {
        validate: (value) => {
            if (!value.trim()) return 'Unit is required';
            if (value.length > 20) return 'Unit must be 20 characters or less';
            if (!/^[a-zA-Z0-9\s]+$/.test(value)) return 'Unit can only contain letters, numbers, and spaces';
            return null;
        },
        sanitize: (value) => {
            return value.replace(/<[^>]*>/g, '').replace(/[^a-zA-Z0-9\s]/g, '').trim();
        }
    },
    
    // Price validation
    price: {
        validate: (value) => {
            if (!value || value.trim() === '') return 'Price is required';
            if (isNaN(value) || parseFloat(value) <= 0) return 'Price must be greater than 0';
            if (parseFloat(value) > 999999.99) return 'Price is too large';
            return null;
        },
        sanitize: (value) => {
            // Only sanitize if there's a value, don't auto-fill with 0
            if (!value || value.trim() === '') return '';
            const num = parseFloat(value);
            return isNaN(num) ? '' : num.toFixed(2);
        }
    },
    
    // Description validation
    description: {
        validate: (value) => {
            if (value && value.length > 500) return 'Description must be 500 characters or less';
            // Only allow letters, numbers, spaces, and basic punctuation
            if (value && !/^[a-zA-Z0-9\s.,!?-]+$/.test(value)) return 'Description can only contain letters, numbers, spaces, and basic punctuation (.,!?-)';
            return null;
        },
        sanitize: (value) => {
            // Remove HTML tags and allow only letters, numbers, spaces, and basic punctuation
            return value.replace(/<[^>]*>/g, '').replace(/[^a-zA-Z0-9\s.,!?-]/g, '').trim();
        }
    },
    
    // Date validation
    date: {
        validate: (value) => {
            if (!value) return 'Date is required';
            const selectedDate = new Date(value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate <= today) return 'Date must be in the future';
            if (selectedDate > new Date(today.getTime() + 3650 * 24 * 60 * 60 * 1000)) {
                return 'Date cannot be more than 10 years in the future';
            }
            return null;
        }
    }
};

// Real-time validation function
function validateField(input, fieldType) {
    const validator = validators[fieldType];
    if (!validator) return;
    
    const value = input.value;
    const error = validator.validate(value);
    
    // Get or create error element
    let errorElement = input.parentNode.querySelector('.validation-error');
    if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.className = 'validation-error text-red-500 text-sm mt-1';
        input.parentNode.appendChild(errorElement);
    }
    
    // Update input styling
    if (error) {
        input.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        input.classList.remove('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
        errorElement.textContent = error;
        errorElement.style.display = 'block';
    } else {
        input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        input.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
        errorElement.style.display = 'none';
    }
    
    return !error;
}

// Sanitize and format input
function sanitizeAndFormat(input, fieldType) {
    const validator = validators[fieldType];
    if (!validator) return;
    
    if (validator.sanitize) {
        input.value = validator.sanitize(input.value);
    }
    
    if (validator.format) {
        input.value = validator.format(input.value);
    }
}

// Real-time validation for all form fields
function setupRealTimeValidation() {
    // Add Item Form
    const addForm = document.getElementById('addItemForm');
    if (addForm) {
        const fields = {
            'name': 'name',
            'quantity': 'quantity', 
            'unit': 'unit',
            'cost_price': 'price',
            'selling_price': 'price',
            'description': 'description',
            'expiry_date': 'date'
        };
        
        Object.entries(fields).forEach(([inputId, fieldType]) => {
            const input = addForm.querySelector(`#${inputId}`);
            if (input) {
                // Real-time validation on input
                input.addEventListener('input', () => {
                    validateField(input, fieldType);
                });
                
                // Sanitize on blur
                input.addEventListener('blur', () => {
                    sanitizeAndFormat(input, fieldType);
                    validateField(input, fieldType);
                });
            }
        });
    }
    
    // Edit Item Form
    const editForm = document.getElementById('editItemForm');
    if (editForm) {
        const fields = {
            'editQuantity': 'quantity',
            'editUnit': 'unit', 
            'editCostPrice': 'price',
            'editSellingPrice': 'price',
            'editDescription': 'description'
        };
        
        Object.entries(fields).forEach(([inputId, fieldType]) => {
            const input = editForm.querySelector(`#${inputId}`);
            if (input) {
                input.addEventListener('input', () => {
                    validateField(input, fieldType);
                });
                
                input.addEventListener('blur', () => {
                    sanitizeAndFormat(input, fieldType);
                    validateField(input, fieldType);
                });
            }
        });
    }
}

// Form submission validation
function validateForm(formId) {
    const form = document.getElementById(formId);
    if (!form) return false;
    
    let isValid = true;
    const fields = {
        'name': 'name',
        'quantity': 'quantity',
        'unit': 'unit', 
        'cost_price': 'price',
        'selling_price': 'price',
        'description': 'description'
    };
    
    // Validate all fields
    Object.entries(fields).forEach(([inputId, fieldType]) => {
        const input = form.querySelector(`#${inputId}`);
        if (input && !validateField(input, fieldType)) {
            isValid = false;
        }
    });
    
    return isValid;
}

// Legacy functions for backward compatibility
function sanitizeInput(input) {
    input.value = input.value.replace(/<[^>]*>/g, '').replace(/[^a-zA-Z0-9\s.,!?-]/g, '').trim();
}

function formatToTitleCase(str) {
    return str.toLowerCase().split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function handleQuantityInput(input) {
    input.value = Math.max(0, parseFloat(input.value) || 0).toFixed(2);
}

function handlePriceInput(input) {
    input.value = Math.max(0, parseFloat(input.value) || 0).toFixed(2);
}

function handleDiscountedPrice(input) {
    const sellingPrice = parseFloat(document.getElementById('editSellingPrice').value) || 0;
    const discountedPrice = parseFloat(input.value) || 0;
    
    if (discountedPrice > sellingPrice) {
        input.setCustomValidity('Discounted price cannot be higher than selling price');
    } else {
        input.setCustomValidity('');
    }
    
    input.value = Math.max(0, discountedPrice).toFixed(2);
}

function sanitizeInput(input) {
    // Remove HTML tags
    let value = input.value.replace(/<[^>]*>/g, '');
    
    // Remove special characters except basic punctuation
    value = value.replace(/[^a-zA-Z0-9\s.,!?-]/g, '');
    
    // Trim whitespace
    value = value.trim();
    
    // Update input value
    input.value = value;
}

function formatToTitleCase(str) {
    return str.toLowerCase().split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

// Function to add a new row to the table
function addItemToTable(item) {
    const tbody = document.querySelector('tbody');
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-item-id', item.id);
    
    // Calculate days until expiry
    let daysUntilExpiry = null;
    if (item.expiry_date) {
        const expiryDate = new Date(item.expiry_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const diffTime = expiryDate - today;
        daysUntilExpiry = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }
    
    // Determine status badge
    let statusBadge = '';
    if (item.status === 'active') {
        statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>';
    } else if (item.status === 'expired') {
        statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Expired</span>';
    } else if (item.status === 'expiring_soon') {
        statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">Expiring Soon</span>';
    } else if (item.status === 'pending_expiry_date') {
        statusBadge = `
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                Pending Expiry Date
            </span>
            <p class="text-xs text-gray-500 mt-1">Please set expiry date</p>
        `;
    }
    
    // Create expiry date display
    let expiryDisplay = '';
    if (item.expiry_date) {
        const formattedDate = item.expiry_date.split('T')[0]; // Get just the date part
        expiryDisplay = `
            <div class="flex items-center space-x-2">
                <div class="text-base text-gray-900">
                    ${formattedDate}
                </div>
                <button data-action="edit-expiry" data-item-id="${item.id}" data-current-date="${formattedDate}" class="text-xs bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2 py-1 rounded shadow hover:from-blue-600 hover:to-purple-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Change</button>
            </div>
            <div class="text-sm text-gray-500">
                ${daysUntilExpiry} days
            </div>
        `;
    } else if (item.status === 'pending_expiry_date') {
        expiryDisplay = `
            <div class="text-sm text-yellow-600 cursor-pointer hover:bg-yellow-50 p-1 rounded font-medium" 
                 data-action="edit-expiry" data-item-id="${item.id}" data-current-date="">
                Set expiry date
            </div>
        `;
    } else {
        expiryDisplay = `
            <div class="text-sm text-gray-500 cursor-pointer hover:bg-gray-50 p-1 rounded" 
                 data-action="edit-expiry" data-item-id="${item.id}" data-current-date="">
                N/A
            </div>
        `;
    }
    
    // Create discounted price display
    let discountedPriceDisplay = '';
    if (item.discounted_price) {
        discountedPriceDisplay = `
            <div class="text-sm text-blue-600 font-medium">
                Discounted: £${item.discounted_price.toFixed(2)}
            </div>
        `;
    }
    
    newRow.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <input type="checkbox" class="item-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="${item.id}" style="display: none;">
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-base font-semibold text-gray-900">${item.name}</div>
            <div class="text-sm text-gray-500">${item.description || ''}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-base text-purple-600 font-semibold">${item.quantity}</td>
        <td class="px-6 py-4 whitespace-nowrap text-base text-indigo-600 font-semibold">${item.unit}</td>
        <td class="px-6 py-4 whitespace-nowrap text-base text-red-600 font-semibold">£${item.cost_price.toFixed(2)}</td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-base text-green-600 font-semibold">£${item.selling_price.toFixed(2)}</div>
            ${discountedPriceDisplay}
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            ${expiryDisplay}
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            ${statusBadge}
        </td>
        <td class="px-6 py-4 text-base font-semibold">
            <button data-action="edit" data-item-id="${item.id}" 
                    class="text-blue-600 hover:text-blue-900 mr-3"
                    ${!['active', 'expiring_soon', 'pending'].includes(item.status) ? 'disabled' : ''}>
                Edit
            </button>
            <button data-action="delete" data-item-id="${item.id}" 
                    class="text-red-600 hover:text-red-900">
                Delete
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
}

// Function to update an existing row in the table
function updateItemInTable(item) {
    const row = document.querySelector(`tr[data-item-id="${item.id}"]`);
    if (row) {
        // Remove the old row and add the updated one
        row.remove();
        addItemToTable(item);
    }
}

// Function to remove an item from the table
function removeItemFromTable(itemId) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (row) {
        row.remove();
    }
}

// Modern notification functions
function showSuccessNotification(message) {
    const successNotification = document.getElementById('successNotification');
    const errorNotification = document.getElementById('errorNotification');
    const successMessage = document.getElementById('successMessage');
    
    // Hide error notification if visible
    errorNotification.classList.add('hidden');
    
    // Set success message
    successMessage.textContent = message;
    
    // Show success notification
    successNotification.classList.remove('hidden');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        hideSuccessNotification();
    }, 5000);
}

function hideSuccessNotification() {
    const successNotification = document.getElementById('successNotification');
    successNotification.classList.add('hidden');
}

function showErrorNotification(message) {
    const errorNotification = document.getElementById('errorNotification');
    const successNotification = document.getElementById('successNotification');
    const errorMessage = document.getElementById('errorMessage');
    
    // Hide success notification if visible
    successNotification.classList.add('hidden');
    
    // Set error message
    errorMessage.textContent = message;
    
    // Show error notification
    errorNotification.classList.remove('hidden');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        hideErrorNotification();
    }, 5000);
}

function hideErrorNotification() {
    const errorNotification = document.getElementById('errorNotification');
    errorNotification.classList.add('hidden');
}

function showWarningNotification(message) {
    const warningNotification = document.getElementById('warningNotification');
    const successNotification = document.getElementById('successNotification');
    const errorNotification = document.getElementById('errorNotification');
    const warningMessage = document.getElementById('warningMessage');
    
    // Hide other notifications if visible
    successNotification.classList.add('hidden');
    errorNotification.classList.add('hidden');
    
    // Set warning message
    warningMessage.textContent = message;
    
    // Show warning notification
    warningNotification.classList.remove('hidden');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        hideWarningNotification();
    }, 5000);
}

function hideWarningNotification() {
    const warningNotification = document.getElementById('warningNotification');
    warningNotification.classList.add('hidden');
}

// Delete confirmation modal functions
function showDeleteConfirmationModal(item) {
    const modal = document.getElementById('deleteConfirmationModal');
    const title = document.getElementById('deleteModalTitle');
    const message = document.getElementById('deleteModalMessage');
    const details = document.getElementById('deleteModalDetails');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    // Set modal content
    title.textContent = `Delete "${item.name}"`;
    message.textContent = 'Are you sure you want to delete this item? This action cannot be undone.';
    
    // Create item details
    const expiryDate = item.expiry_date ? new Date(item.expiry_date).toLocaleDateString() : 'Not set';
    details.innerHTML = `
        <div class="space-y-2">
            <div><strong>Name:</strong> ${item.name}</div>
            <div><strong>Quantity:</strong> ${item.quantity} ${item.unit}</div>
            <div><strong>Cost Price:</strong> £${item.cost_price.toFixed(2)}</div>
            <div><strong>Selling Price:</strong> £${item.selling_price.toFixed(2)}</div>
            <div><strong>Expiry Date:</strong> ${expiryDate}</div>
            ${item.description ? `<div><strong>Description:</strong> ${item.description}</div>` : ''}
        </div>
    `;
    
    // Set up confirm button action
    confirmBtn.onclick = () => {
        hideDeleteConfirmationModal();
        performDeleteItem(item.id);
    };
    
    // Show modal
    modal.classList.remove('hidden');
}

function hideDeleteConfirmationModal() {
    const modal = document.getElementById('deleteConfirmationModal');
    modal.classList.add('hidden');
}

// Bulk delete confirmation modal functions
function showBulkDeleteConfirmationModal(items) {
    const modal = document.getElementById('bulkDeleteConfirmationModal');
    const title = document.getElementById('bulkDeleteModalTitle');
    const message = document.getElementById('bulkDeleteModalMessage');
    const details = document.getElementById('bulkDeleteModalDetails');
    const confirmBtn = document.getElementById('confirmBulkDeleteBtn');
    
    // Set modal content
    title.textContent = `Delete ${items.length} Item${items.length > 1 ? 's' : ''}`;
    message.textContent = `Are you sure you want to delete ${items.length} selected item${items.length > 1 ? 's' : ''}? This action cannot be undone.`;
    
    // Create items details
    let detailsHTML = '<div class="space-y-3">';
    items.forEach((item, index) => {
        const expiryDate = item.expiry_date ? new Date(item.expiry_date).toLocaleDateString() : 'Not set';
        detailsHTML += `
            <div class="border-b border-gray-200 pb-2 ${index < items.length - 1 ? 'mb-2' : ''}">
                <div class="font-medium text-gray-900">${index + 1}. ${item.name}</div>
                <div class="text-sm text-gray-600">
                    Quantity: ${item.quantity} ${item.unit} | 
                    Price: £${item.selling_price.toFixed(2)} | 
                    Expiry: ${expiryDate}
                </div>
            </div>
        `;
    });
    detailsHTML += '</div>';
    details.innerHTML = detailsHTML;
    
    // Set up confirm button action
    confirmBtn.onclick = () => {
        hideBulkDeleteConfirmationModal();
        performBulkDeleteItems(items.map(item => item.id));
    };
    
    // Show modal
    modal.classList.remove('hidden');
}

function hideBulkDeleteConfirmationModal() {
    const modal = document.getElementById('bulkDeleteConfirmationModal');
    modal.classList.add('hidden');
}

// Perform actual delete operations
async function performDeleteItem(itemId) {
    try {
        const deleteResponse = await fetch(`/api/v1/items/${itemId}`, {
            method: 'DELETE'
        });
        
        if (deleteResponse.ok) {
            const result = await deleteResponse.json();
            showSuccessNotification(result.message || 'Item deleted successfully!');
            removeItemFromTable(itemId);
        } else {
            const error = await deleteResponse.json();
            throw new Error(error.error || 'Failed to delete item');
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification(error.message || 'Failed to delete item');
    }
}

async function performBulkDeleteItems(itemIds) {
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        if (!csrfToken) {
            showErrorNotification('CSRF token missing. Please refresh the page and try again.');
            return;
        }
        
        const deleteResponse = await fetch('/api/v1/items/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'include',
            body: JSON.stringify({
                item_ids: itemIds
            })
        });
        
        const data = await deleteResponse.json();
        
        if (deleteResponse.ok) {
            showSuccessNotification(data.message || 'Items deleted successfully!');
            itemIds.forEach(itemId => removeItemFromTable(itemId));
            cancelBulkDelete();
        } else {
            throw new Error(data.error || 'Failed to delete items');
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification(error.message || 'An error occurred while deleting items');
        cancelBulkDelete();
    }
}

// Legacy function for backward compatibility
function showSuccessMessage(message) {
    showSuccessNotification(message);
}

// Inline expiry date editing function
function editExpiryDateInline(itemId, currentDate) {
    // Find the expiry date cell for this item
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (!row) return;
    
    const expiryCell = row.querySelector('td:nth-child(7)'); // Expiry date column
    if (!expiryCell) return;
    
    // Create the inline editor
    const editor = document.createElement('div');
    editor.className = 'flex flex-col space-y-2'; // Use flex-col for vertical stacking
    editor.innerHTML = `
        <input type="date" 
               class="text-sm border border-blue-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
               value="${currentDate || ''}"
               min="${new Date().toISOString().split('T')[0]}"
               max="${new Date(Date.now() + 3650 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
        <div class="flex space-x-2">
            <button onclick="saveExpiryDateInline(${itemId})" 
                    class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 flex-grow">
                Save
            </button>
            <button onclick="cancelExpiryDateInline(${itemId})" 
                    class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600 flex-grow">
                Cancel
            </button>
        </div>
    `;
    
    // Store the original content for restoration
    expiryCell.setAttribute('data-original-content', expiryCell.innerHTML);
    
    // Replace the content with the editor
    expiryCell.innerHTML = '';
    expiryCell.appendChild(editor);
    
    // Focus on the date input
    const dateInput = editor.querySelector('input[type="date"]');
    dateInput.focus();
}

// Save the inline edited expiry date
async function saveExpiryDateInline(itemId) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (!row) return;
    
    const expiryCell = row.querySelector('td:nth-child(7)');
    if (!expiryCell) return;
    
    const dateInput = expiryCell.querySelector('input[type="date"]');
    const newDate = dateInput.value;
    
    if (!newDate) {
        showWarningNotification('Please select a valid expiry date');
        return;
    }
    
    // Validate the date is in the future
    const selectedDate = new Date(newDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate <= today) {
        showWarningNotification('Expiry date must be in the future');
        return;
    }
    
    // Validate the date is not more than 10 years in the future
    const maxDate = new Date(today.getTime() + 3650 * 24 * 60 * 60 * 1000); // 10 years from today
    if (selectedDate > maxDate) {
        showWarningNotification('Expiry date cannot be more than 10 years in the future');
        return;
    }
    
    try {
        // Get current item data
        const response = await fetch(`/api/v1/items/${itemId}`);
        if (!response.ok) {
            throw new Error('Failed to get item details');
        }
        const result = await response.json();
        
        // Log the response for debugging
        console.log('API Response:', result);
        
        // Check if item exists in response
        if (!result || !result.item) {
            console.error('Invalid API response structure:', result);
            throw new Error('Item not found or invalid response');
        }
        
        const item = result.item;
        
        // Update the item with new expiry date
        const updateData = {
            name: item.name,
            description: item.description || '',
            quantity: item.quantity,
            unit: item.unit,
            selling_price: item.selling_price,
            cost_price: item.cost_price,
            expiry_date: newDate
        };
        
        const updateResponse = await fetch(`/api/v1/items/${itemId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(updateData)
        });
        
        if (updateResponse.ok) {
            const updateResult = await updateResponse.json();
            showSuccessNotification('Expiry date updated successfully!');
            
            // Update the table row with new data
            if (updateResult && updateResult.item) {
                updateItemInTable(updateResult.item);
            } else {
                // If no item returned, refresh the page to show updated data
                location.reload();
            }
        } else {
            const error = await updateResponse.json();
            throw new Error(error.error || 'Failed to update expiry date');
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification(error.message || 'Failed to update expiry date');
        // Restore original content
        cancelExpiryDateInline(itemId);
    }
}

// Cancel inline editing and restore original content
function cancelExpiryDateInline(itemId) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (!row) return;
    
    const expiryCell = row.querySelector('td:nth-child(7)');
    if (!expiryCell) return;
    
    const originalContent = expiryCell.getAttribute('data-original-content');
    if (originalContent) {
        expiryCell.innerHTML = originalContent;
        expiryCell.removeAttribute('data-original-content');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] DOMContentLoaded fired');
    console.log('[DEBUG] Testing event delegation setup...');
    
    // Test if we can find any buttons with data-action
    const actionButtons = document.querySelectorAll('[data-action]');
    console.log('[DEBUG] Found', actionButtons.length, 'elements with data-action attributes');
    actionButtons.forEach(btn => {
        console.log('[DEBUG] Button:', btn.dataset.action, 'ID:', btn.dataset.itemId);
    });
    
    // Initialize real-time validation
    setupRealTimeValidation();
    
    // Add event delegation for edit and delete buttons
    document.addEventListener('click', function(e) {
        console.log('[DEBUG] Click event triggered on:', e.target);
        const button = e.target.closest('[data-action]');
        if (!button) {
            console.log('[DEBUG] No data-action element found');
            return;
        }
        
        const action = button.dataset.action;
        const itemId = button.dataset.itemId;
        
        console.log('[DEBUG] Action:', action, 'Item ID:', itemId);
        
        if (action === 'edit') {
            console.log('[DEBUG] Calling editItem with ID:', itemId);
            editItem(itemId);
        } else if (action === 'delete') {
            console.log('[DEBUG] Calling deleteItem with ID:', itemId);
            deleteItem(itemId);
        } else if (action === 'edit-expiry') {
            const currentDate = button.dataset.currentDate || null;
            console.log('[DEBUG] Calling editExpiryDateInline with ID:', itemId, 'Date:', currentDate);
            editExpiryDateInline(itemId, currentDate);
        }
    });
    
    // Add validation for expiry date input
    const expiryDateInput = document.getElementById('expiry_date');
    if (expiryDateInput) {
        expiryDateInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);  // Reset time part for fair comparison
            
            if (selectedDate <= today) {
                this.setCustomValidity('Expiry date must be in the future');
            } else if (selectedDate > new Date(today.getTime() + 3650 * 24 * 60 * 60 * 1000)) {
                this.setCustomValidity('Expiry date cannot be more than 10 years in the future');
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    // Add event listener for bulk delete button (only if it exists)
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    if (bulkDeleteBtn) {
        console.log('[DEBUG] bulkDeleteBtn found, adding event listener');
        bulkDeleteBtn.addEventListener('click', () => {
            console.log('[DEBUG] bulkDeleteBtn clicked, calling toggleBulkDelete');
            toggleBulkDelete();
        });
    } else {
        console.log('[DEBUG] bulkDeleteBtn NOT found in DOM');
    }
    
    // Add event listener for select all checkbox (only if it exists)
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
        });
    }
    
    // Show warning for items without expiry dates
    document.querySelectorAll('tr').forEach(row => {
        const statusCell = row.querySelector('td:nth-child(4)');  // Status column
        const expiryCell = row.querySelector('td:nth-child(3)');  // Expiry date column
        
        if (statusCell && statusCell.textContent.trim() === '{{ STATUS_PENDING }}') {
            row.classList.add('bg-yellow-50');
        }
    });
    
    // Add event listeners for filter elements
    const statusFilter = document.getElementById('status');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
        
        // Add clear search functionality
        const clearSearchBtn = document.getElementById('clear-search');
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                applyFilters();
            });
        }
        
        // Show/hide clear search button
        searchInput.addEventListener('input', function() {
            const clearSearchBtn = document.getElementById('clear-search');
            if (clearSearchBtn) {
                clearSearchBtn.style.display = this.value ? 'flex' : 'none';
            }
        });
    }
    
    // Add event listeners for new filter elements
    const priceRangeFilter = document.getElementById('price_range');
    if (priceRangeFilter) {
        priceRangeFilter.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    const quantityStatusFilter = document.getElementById('quantity_status');
    if (quantityStatusFilter) {
        quantityStatusFilter.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    const dateRangeFilter = document.getElementById('date_range');
    if (dateRangeFilter) {
        dateRangeFilter.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    // Add event listener for clear all filters button
    const clearFiltersBtn = document.getElementById('clear-filters');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            clearAllFilters();
        });
    }
});

// ... existing code ...
</script>

<div class="min-h-screen w-full bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 py-10 px-2 md:px-8">
    <div class="max-w-7xl mx-auto">
        {% if not current_user.zoho_access_token %}
            <div class="bg-yellow-100 border-l-4 border-yellow-400 p-4 mb-8 rounded-lg shadow flex items-center">
                <svg class="h-6 w-6 text-yellow-400 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-yellow-800 text-base font-medium">
                    Zoho sync is not available. Please connect your Zoho account in <a href="{{ url_for('main.settings') }}" class="underline hover:text-yellow-600">Settings</a> to sync your inventory.
                </span>
            </div>
        {% else %}
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-8 gap-4">
                <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight drop-shadow">Inventory</h1>
                <div class="flex flex-wrap gap-3 justify-end items-center">
                    <a href="{{ url_for('reports.reports') }}" class="original-button bg-gradient-to-r from-purple-500 to-pink-500 text-white px-5 py-2 rounded-lg shadow hover:from-purple-600 hover:to-pink-600 font-semibold transition">View Reports</a>
                    <button id="bulkDeleteBtn" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-5 py-2 rounded-lg shadow hover:from-red-600 hover:to-pink-600 font-semibold transition">Bulk Delete</button>
                    <button id="deleteSelectedBtn" onclick="deleteSelectedItems()" style="display: none;" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-5 py-2 rounded-lg shadow font-semibold transition">Delete Selected</button>
                    <button id="cancelBulkDeleteBtn" onclick="cancelBulkDelete()" style="display: none;" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg shadow font-semibold transition hover:bg-gray-400">Cancel</button>
                    <button onclick="document.getElementById('addItemModal').classList.remove('hidden')" class="original-button bg-gradient-to-r from-blue-500 to-purple-500 text-white px-5 py-2 rounded-lg shadow hover:from-blue-600 hover:to-purple-600 font-semibold transition">Add Item</button>
                </div>
            </div>

            <!-- Enhanced Filters -->
            <div class="bg-white/80 rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex flex-col space-y-4">
                    <!-- Search Section -->
                    <div class="flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <label for="search" class="block text-sm font-semibold text-gray-700 mb-2">Search Items</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="search" name="search" value="{{ current_search }}" 
                                       placeholder="Search by name or description..." 
                                       class="block w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-base" />
                                <button id="clear-search" 
                                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors duration-200"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Search in item names and descriptions</p>
                        </div>
                        <div class="flex items-end">
                            <button id="clear-filters" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-3 rounded-lg shadow hover:from-gray-600 hover:to-gray-700 font-semibold transition">
                                <i class="fas fa-times mr-2"></i>Clear All
                            </button>
                        </div>
                    </div>

                    <!-- Filter Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Status Filter -->
                        <div>
                            <label for="status" class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                            <select id="status" name="status" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base py-3">
                        <option value="">All Status</option>
                        <option value="{{ STATUS_ACTIVE }}" {% if current_status == STATUS_ACTIVE %}selected{% endif %}>Active</option>
                        <option value="{{ STATUS_EXPIRED }}" {% if current_status == STATUS_EXPIRED %}selected{% endif %}>Expired</option>
                        <option value="{{ STATUS_EXPIRING_SOON }}" {% if current_status == STATUS_EXPIRING_SOON %}selected{% endif %}>Expiring Soon</option>
                                <option value="{{ STATUS_PENDING }}" {% if current_status == STATUS_PENDING %}selected{% endif %}>Pending Expiry Date</option>
                    </select>
                </div>

                        <!-- Price Range Filter -->
                        <div>
                            <label for="price_range" class="block text-sm font-semibold text-gray-700 mb-2">Price Range</label>
                            <select id="price_range" name="price_range" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base py-3">
                                <option value="">All Prices</option>
                                <optgroup label="Cost Price (What you paid)">
                                    <option value="cost_under_50">Cost: Under £50</option>
                                    <option value="cost_50_100">Cost: £50 - £100</option>
                                    <option value="cost_over_100">Cost: Over £100</option>
                                </optgroup>
                                <optgroup label="Selling Price (Customer pays)">
                                    <option value="selling_under_50">Selling: Under £50</option>
                                    <option value="selling_50_100">Selling: £50 - £100</option>
                                    <option value="selling_over_100">Selling: Over £100</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Quantity Status Filter -->
                        <div>
                            <label for="quantity_status" class="block text-sm font-semibold text-gray-700 mb-2">Stock Level</label>
                            <select id="quantity_status" name="quantity_status" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base py-3">
                                <option value="">All Quantities</option>
                                <option value="low_stock">Low Stock (< 10)</option>
                                <option value="out_of_stock">Out of Stock (0)</option>
                                <option value="well_stocked">Well Stocked (≥ 10)</option>
                            </select>
                        </div>

                        <!-- Date Range Filter -->
                        <div>
                            <label for="date_range" class="block text-sm font-semibold text-gray-700 mb-2">Expiry Date</label>
                            <select id="date_range" name="date_range" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base py-3">
                                <option value="">All Dates</option>
                                <option value="7_days">Expires in 7 days</option>
                                <option value="30_days">Expires in 30 days</option>
                                <option value="90_days">Expires in 90 days</option>
                                <option value="no_expiry">No expiry date</option>
                            </select>
                        </div>
                    </div>

                    <!-- Active Filters Display -->
                    <div id="active-filters" class="flex flex-wrap gap-2 pt-2" style="display: none;">
                        <!-- Active filters will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Items Table -->
            <div class="bg-white/90 rounded-2xl shadow-2xl overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-purple-100 to-pink-100">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="display: none;">
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-purple-50 transition" onclick="sortTable(1)">
                                Name <span class="sort-icon">↕</span>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-purple-50 transition" onclick="sortTable(2)">
                                Quantity <span class="sort-icon">↕</span>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Unit</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-purple-50 transition" onclick="sortTable(4)">
                                Cost Price <span class="sort-icon">↕</span>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-purple-50 transition" onclick="sortTable(5)">
                                Selling Price <span class="sort-icon">↕</span>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-purple-50 transition" onclick="sortTable(6)">
                                Expiry Date <span class="sort-icon">↕</span>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-purple-50 transition" onclick="sortTable(7)">
                                Status <span class="sort-icon">↕</span>
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in items %}
                            <tr data-item-id="{{ item.id }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" class="item-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="{{ item.id }}" style="display: none;">
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-base font-semibold text-gray-900">{{ item.name }}</div>
                                    <div class="text-sm text-gray-500">{{ item.description }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-base text-purple-600 font-semibold">{{ item.quantity }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-base text-indigo-600 font-semibold">{{ item.unit }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-base text-red-600 font-semibold">£{{ "%.2f"|format(item.cost_price) }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-base text-green-600 font-semibold">£{{ "%.2f"|format(item.selling_price) }}</div>
                                    {% if item.discounted_price %}
                                        <div class="text-sm text-blue-600 font-semibold">
                                            Discounted: £{{ "%.2f"|format(item.discounted_price) }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if item.expiry_date %}
                                        <div class="flex items-center space-x-2">
                                            <div class="text-base text-gray-900">
                                                {{ item.expiry_date.strftime('%Y-%m-%d') }}
                                            </div>
                                            <button data-action="edit-expiry" data-item-id="{{ item.id }}" data-current-date="{{ item.expiry_date.strftime('%Y-%m-%d') }}" class="text-xs bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2 py-1 rounded shadow hover:from-blue-600 hover:to-purple-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Change</button>
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if item.days_until_expiry is not none %}
                                                {{ item.days_until_expiry }} days
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        {% if item.status == STATUS_PENDING %}
                                            <div class="text-sm text-yellow-600 cursor-pointer hover:bg-yellow-50 p-1 rounded font-medium" data-action="edit-expiry" data-item-id="{{ item.id }}" data-current-date="">Set expiry date</div>
                                        {% else %}
                                            <div class="text-sm text-gray-500 cursor-pointer hover:bg-gray-50 p-1 rounded" data-action="edit-expiry" data-item-id="{{ item.id }}" data-current-date="">N/A</div>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if item.status == 'pending_expiry_date' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending Expiry Date</span>
                                        <p class="text-xs text-gray-500 mt-1">Please set expiry date within 24 hours</p>
                                    {% elif item.status == 'expiring_soon' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">Expiring Soon</span>
                                    {% elif item.status == 'active' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                    {% elif item.status == 'expired' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Expired</span>
                                    {% else %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-base font-semibold">
                                    <button data-action="edit" data-item-id="{{ item.id }}" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                                    <button data-action="delete" data-item-id="{{ item.id }}" class="text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="9" class="px-6 py-4 text-center text-gray-500">No items found. Connect to Zoho to sync your inventory!</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-8 border-0 w-full max-w-md shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
        <div class="mt-3">
            <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">Add New Item</h3>
            <form id="addItemForm" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div>
                    <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">Name *</label>
                    <input type="text" id="name" name="name" required maxlength="100"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                           placeholder="Enter item name">
                    <p class="mt-2 text-sm text-gray-500">Maximum 100 characters</p>
                </div>
                <div>
                    <label for="quantity" class="block text-sm font-semibold text-gray-700 mb-2">Quantity *</label>
                    <input type="number" id="quantity" name="quantity" required min="0.01" step="0.01"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                           placeholder="Enter quantity">
                    <p class="mt-2 text-sm text-gray-500">Must be greater than 0</p>
                </div>
                <div>
                    <label for="unit" class="block text-sm font-semibold text-gray-700 mb-2">Unit *</label>
                    <input type="text" id="unit" name="unit" required maxlength="20"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                           placeholder="e.g., kg, pieces, liters">
                    <p class="mt-2 text-sm text-gray-500">Maximum 20 characters</p>
                </div>
                <div>
                    <label for="cost_price" class="block text-sm font-semibold text-gray-700 mb-2">Cost Price *</label>
                    <input type="number" id="cost_price" name="cost_price" required min="0.01" step="0.01"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                           placeholder="Enter cost price">
                    <p class="mt-2 text-sm text-gray-500">Must be greater than 0</p>
                </div>
                <div>
                    <label for="selling_price" class="block text-sm font-semibold text-gray-700 mb-2">Selling Price *</label>
                    <input type="number" id="selling_price" name="selling_price" required min="0.01" step="0.01"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                           placeholder="Enter selling price">
                    <p class="mt-2 text-sm text-gray-500">Must be greater than 0</p>
                </div>
                <div>
                    <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                    <textarea id="description" name="description" rows="3" maxlength="500"
                              class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                              placeholder="Optional description"></textarea>
                    <p class="mt-2 text-sm text-gray-500">Maximum 500 characters</p>
                </div>
                <div>
                    <label for="expiry_date" class="block text-sm font-semibold text-gray-700 mb-2">Expiry Date *</label>
                    <div class="flex space-x-3">
                        <input type="date" id="expiry_date" name="expiry_date" required
                               min="{{ now.strftime('%Y-%m-%d') }}"
                               max="{{ (now + timedelta(days=3650)).strftime('%Y-%m-%d') }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3">
                        <div class="flex items-center space-x-2">
                            <button type="button" id="uploadBtn" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-3 rounded-lg shadow hover:from-blue-600 hover:to-purple-600 font-semibold transition">
                                Upload Image
                            </button>
                            <input type="file" id="dateImageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                            <div class="relative group">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div class="absolute left-0 mt-2 w-64 p-3 bg-gray-800 text-white text-sm rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                    <p class="font-semibold mb-1">Date Format Information:</p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Supported formats: DD/MM/YYYY, DD-MM-YYYY</li>
                                        <li>Example: 25/12/2024 or 25-12-2024</li>
                                        <li>Make sure the date is clearly visible in the image</li>
                                        <li>For best results, take a clear photo of the expiry date</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="uploadFeedback" class="mt-2 text-sm hidden">
                        <p class="text-gray-500">Processing image...</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeAddModal()"
                            class="px-6 py-3 text-base font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-6 py-3 text-base font-semibold text-white bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg shadow hover:from-blue-600 hover:to-purple-600 transition">
                        Add Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="editItemModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-8 border-0 w-full max-w-md shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
        <div class="mt-3">
            <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">Edit Item</h3>
            <div id="editStatusMessage" class="mb-6 hidden">
                <p class="text-sm text-yellow-600"></p>
            </div>
            <form id="editItemForm" class="space-y-6">
                <input type="hidden" id="editItemId" name="id">
                <input type="hidden" id="editItemStatus" name="status">
                <input type="hidden" id="editZohoItemId" name="zoho_item_id">
                <input type="hidden" id="editNameHidden" name="name">
                <div>
                    <label for="editName" class="block text-sm font-semibold text-gray-700 mb-2">Name *</label>
                    <input type="text" name="name" id="editName" required maxlength="100"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3 bg-gray-100"
                           disabled>
                    <p class="mt-2 text-sm text-gray-500">Maximum 100 characters</p>
                </div>
                <div>
                    <label for="editQuantity" class="block text-sm font-semibold text-gray-700 mb-2">Quantity *</label>
                    <input type="number" name="quantity" id="editQuantity" step="0.01" required min="0.01"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3">
                    <p class="mt-2 text-sm text-gray-500">Must be greater than 0</p>
                </div>
                <div>
                    <label for="editUnit" class="block text-sm font-semibold text-gray-700 mb-2">Unit *</label>
                    <input type="text" name="unit" id="editUnit" required maxlength="20"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3">
                    <p class="mt-2 text-sm text-gray-500">Maximum 20 characters</p>
                </div>
                <div>
                    <label for="editCostPrice" class="block text-sm font-semibold text-gray-700 mb-2">Cost Price *</label>
                    <input type="number" name="cost_price" id="editCostPrice" step="0.01" required min="0.01"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3">
                    <p class="mt-2 text-sm text-gray-500">Must be greater than 0</p>
                </div>
                <div>
                    <label for="editSellingPrice" class="block text-sm font-semibold text-gray-700 mb-2">Selling Price *</label>
                    <input type="number" name="selling_price" id="editSellingPrice" step="0.01" required min="0.01"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3">
                    <p class="mt-2 text-sm text-gray-500">Must be greater than 0</p>
                </div>
                <div id="editDiscountedPriceContainer" class="hidden">
                    <label for="editDiscountedPrice" class="block text-sm font-semibold text-gray-700 mb-2">Discounted Price</label>
                    <input type="number" name="discounted_price" id="editDiscountedPrice" step="0.01"
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                           onblur="handleDiscountedPrice(this)">
                    <p id="editDiscountedPriceHelp" class="mt-2 text-sm text-gray-500"></p>
                </div>
                <div>
                    <label for="editDescription" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                    <textarea name="description" id="editDescription" rows="2" maxlength="500"
                              class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-400 focus:ring-2 focus:ring-purple-200 text-base px-4 py-3"
                              onblur="sanitizeInput(this)"></textarea>
                    <p class="mt-2 text-sm text-gray-500">Maximum 500 characters</p>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeEditModal()"
                            class="px-6 py-3 text-base font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-6 py-3 text-base font-semibold text-white bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg shadow hover:from-blue-600 hover:to-purple-600 transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentSort = {
    column: null,
    direction: 'asc'
};

function validateDecimalPlaces(input, maxDecimals) {
    // Get the current value
    let value = input.value;
    
    // If the value is empty, return
    if (!value) return;
    
    // If the value ends with a decimal point, don't modify it
    if (value.endsWith('.')) return;
    
    // Only validate if the input is complete (not in the middle of typing)
    if (value.includes('.')) {
        // Split into whole and decimal parts
        const parts = value.split('.');
        // If decimal part is longer than maxDecimals, truncate it
        if (parts[1].length > maxDecimals) {
            // Convert to number and back to string to handle scientific notation
            value = parseFloat(value).toFixed(maxDecimals);
            // Update the input value
            input.value = value;
        }
    }
}

function handlePriceInput(input) {
    if (!input.value) {
        input.value = '';
        return;
    }
    
    // Only format on blur, not during typing
    if (document.activeElement !== input) {
        // Round to 2 decimal places
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
            // Check for negative values
            if (value < 0) {
                alert('Price cannot be negative');
                input.value = '';
                return;
            }
            
            // Only format if the value is different from what's displayed
            // This prevents unwanted rounding while typing
            const currentDisplay = parseFloat(input.value);
            if (Math.abs(value - currentDisplay) > 0.001) {
                input.value = value.toFixed(2);
            }
        }
    }
}

function handleDiscountedPrice(input) {
    // If empty or just whitespace, clear the value
    if (!input.value || input.value.trim() === '') {
        input.value = '';
        return;
    }
    
    // Only format on blur, not during typing
    if (document.activeElement !== input) {
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
            // Check for negative values
            if (value < 0) {
                alert('Discounted price cannot be negative');
                input.value = '';
                return;
            }
            
            // If the value is 0, keep it as 0
            if (value === 0) {
                input.value = '0';
                return;
            }
            
            // Only format if the value is different from what's displayed
            const currentDisplay = parseFloat(input.value);
            if (Math.abs(value - currentDisplay) > 0.001) {
                input.value = value.toFixed(2);
            }
        }
    }
}

document.getElementById('addItemForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Use the new validation system
    if (!validateForm('addItemForm')) {
        alert('Please fix the validation errors before submitting.');
        return;
    }
    
    // Get form data
    const formData = new FormData(this);
    const name = formData.get('name');
    const quantity = formData.get('quantity');
    const unit = formData.get('unit');
    const costPrice = formData.get('cost_price');
    const sellingPrice = formData.get('selling_price');
    const expiryDate = formData.get('expiry_date');
    const description = formData.get('description');
    
    try {
        // Check if item exists
        const response = await fetch('/api/v1/items/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ name: formatToTitleCase(name.trim()) })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to check item existence');
        }
        
        const data = await response.json();
        
        if (data.exists) {
            // Show modern confirmation modal instead of simple confirm
            const itemData = {
                name: formatToTitleCase(name.trim()),
                description: description ? description.trim() : '',
                quantity: parseFloat(quantity),
                unit: unit.trim(),
                selling_price: parseFloat(sellingPrice),
                cost_price: parseFloat(costPrice),
                expiry_date: expiryDate
            };
            
            showItemUpdateConfirmationModal(data.item, itemData);
            return;
        }
        
        // If creating new item, use the API
        const itemData = {
            name: formatToTitleCase(name.trim()),
            description: description ? description.trim() : '',
            quantity: parseFloat(quantity),
            unit: unit.trim(),
            selling_price: parseFloat(sellingPrice),
            cost_price: parseFloat(costPrice),
            expiry_date: expiryDate
        };
        
        const createResponse = await fetch('/api/v1/items', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(itemData)
        });
        
        if (createResponse.ok) {
            const result = await createResponse.json();
            showSuccessNotification(result.message || 'Item created successfully!');
            addItemToTable(result.item);
            closeAddModal();
        } else {
            const errorData = await createResponse.json();
            throw new Error(errorData.error || 'Failed to create item');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while adding/updating the item. Please try again.');
    }
});

document.getElementById('editItemForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Use the new validation system
    if (!validateForm('editItemForm')) {
        showErrorNotification('Please fix the validation errors before submitting.');
        return;
    }
    
    // Get form data
    const formData = new FormData(this);
    const name = formData.get('name');
    const quantity = formData.get('quantity');
    const unit = formData.get('unit');
    const costPrice = formData.get('cost_price');
    const sellingPrice = formData.get('selling_price');
    const discountedPrice = formData.get('discounted_price');
    const description = formData.get('description');
    const itemId = formData.get('id');
    
    try {
        const itemData = {
            name: formatToTitleCase(name.trim()),
            description: description ? description.trim() : '',
            quantity: parseFloat(quantity),
            unit: unit.trim(),
            selling_price: parseFloat(sellingPrice),
            cost_price: parseFloat(costPrice)
        };
        
        // Add discounted price if provided
        if (discountedPrice && discountedPrice.trim() !== '') {
            itemData.discounted_price = parseFloat(discountedPrice);
        }
        
        const response = await fetch(`/api/v1/items/${itemId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(itemData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showSuccessNotification(result.message || 'Item updated successfully!');
            updateItemInTable(result.item);
            // Close the modal using the correct method
            closeEditModal();
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update item');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification(error.message || 'An error occurred while updating the item. Please try again.');
    }
});

async function editItem(itemId) {
    try {
        const response = await fetch(`/api/v1/items/${itemId}`);
        if (!response.ok) {
            throw new Error('Failed to get item details');
        }
        const result = await response.json();
        const item = result.item;
        
        // Populate form fields
        document.getElementById('editItemId').value = item.id;
        document.getElementById('editItemStatus').value = item.status;
        document.getElementById('editZohoItemId').value = item.zoho_item_id || '';
        document.getElementById('editNameHidden').value = item.name;
        
        // Log for debugging
        console.log('Editing item:', {
            id: item.id,
            name: item.name,
            zohoItemId: item.zoho_item_id,
            expiry_date: item.expiry_date,
            expiry_date_type: typeof item.expiry_date,
            expiry_date_length: item.expiry_date ? item.expiry_date.length : 0
        });
        
        document.getElementById('editName').value = item.name;
        document.getElementById('editQuantity').value = item.quantity;
        document.getElementById('editUnit').value = item.unit;
        document.getElementById('editCostPrice').value = item.cost_price;
        document.getElementById('editSellingPrice').value = item.selling_price;
        document.getElementById('editDescription').value = item.description || '';
        
        // Show/hide status message
        const statusMessage = document.getElementById('editStatusMessage');
        const discountedPriceContainer = document.getElementById('editDiscountedPriceContainer');
        
        if (statusMessage) {
            if (item.status === 'expired') {
            statusMessage.classList.remove('hidden');
                const messageP = statusMessage.querySelector('p');
                if (messageP) {
                    messageP.textContent = 'Expired items cannot be edited.';
                }
        } else {
            statusMessage.classList.add('hidden');
            }
        }
            
        // Handle discounted price field
        if (discountedPriceContainer) {
            if (item.status === 'expiring_soon' || item.status === 'active' || item.status === 'pending_expiry_date') {
                discountedPriceContainer.classList.remove('hidden');
                const discountedPriceInput = document.getElementById('editDiscountedPrice');
                if (discountedPriceInput) {
                discountedPriceInput.value = item.discounted_price || '';
                }
                const helpText = document.getElementById('editDiscountedPriceHelp');
                if (helpText) {
                    if (item.status === 'expiring_soon') {
                        helpText.textContent = 'Enter a discounted price for this expiring item';
                    } else if (item.status === 'active') {
                        helpText.textContent = 'Enter a discounted price for this active item';
                    } else if (item.status === 'pending_expiry_date') {
                        helpText.textContent = 'Enter a discounted price for this pending item';
                    }
                }
            } else {
                discountedPriceContainer.classList.add('hidden');
            }
        }
        
        // Show the modal
        const editModal = document.getElementById('editItemModal');
        if (editModal) {
            editModal.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification('Failed to load item details');
    }
}

async function deleteItem(itemId) {
    try {
        // Get item details before deletion
        const response = await fetch(`/api/v1/items/${itemId}`);
        if (!response.ok) {
            throw new Error('Failed to get item details');
        }
        const result = await response.json();
        const item = result.item;
        
        // Show modern confirmation modal with item details
        showDeleteConfirmationModal(item);
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification('Failed to load item details');
    }
}

// Filter form submission - removed filterForm reference since it doesn't exist
// Event listeners are now set up inside DOMContentLoaded event

// Function to apply filters using API
function applyFilters() {
    // Get all filter values with validation and sanitization
    const status = sanitizeInput(document.getElementById('status').value);
    const search = sanitizeInput(document.getElementById('search').value);
    const priceRange = sanitizeInput(document.getElementById('price_range').value);
    const quantityStatus = sanitizeInput(document.getElementById('quantity_status').value);
    const dateRange = sanitizeInput(document.getElementById('date_range').value);
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Validate filter values
    const validationErrors = validateFilters(status, search, priceRange, quantityStatus, dateRange);
    if (validationErrors.length > 0) {
        showErrorNotification('Invalid filter values: ' + validationErrors.join(', '));
        return;
    }
    
    // Build query parameters
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (search) params.append('search', search);
    if (priceRange) params.append('price_range', priceRange);
    if (quantityStatus) params.append('quantity_status', quantityStatus);
    if (dateRange) params.append('date_range', dateRange);
    
    // Update active filters display
    updateActiveFiltersDisplay(status, search, priceRange, quantityStatus, dateRange);
    
    // Show loading state
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';
    
    fetch(`/api/v1/items/filter?${params.toString()}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(items => {
        updateItemsTable(items);
    })
    .catch(error => {
        console.error('Error applying filters:', error);
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-red-500">Error loading items. Please try again.</td></tr>';
        });
    }
    
// Function to sanitize input values
function sanitizeInput(value) {
    if (!value) return '';
    return value.trim().replace(/[<>]/g, ''); // Remove potential HTML tags
}

// Function to validate filter values
function validateFilters(status, search, priceRange, quantityStatus, dateRange) {
    const errors = [];
    
    // Validate status
    const validStatuses = ['', 'active', 'expired', 'expiring_soon', 'pending_expiry_date'];
    if (status && !validStatuses.includes(status)) {
        errors.push('Invalid status value');
    }
    
    // Validate search (max 100 characters)
    if (search && search.length > 100) {
        errors.push('Search term too long (max 100 characters)');
    }
    
    // Validate price range
    const validPriceRanges = ['', 'cost_under_50', 'cost_50_100', 'cost_over_100', 'selling_under_50', 'selling_50_100', 'selling_over_100'];
    if (priceRange && !validPriceRanges.includes(priceRange)) {
        errors.push('Invalid price range value');
    }
    
    // Validate quantity status
    const validQuantityStatuses = ['', 'low_stock', 'out_of_stock', 'well_stocked'];
    if (quantityStatus && !validQuantityStatuses.includes(quantityStatus)) {
        errors.push('Invalid quantity status value');
    }
    
    // Validate date range
    const validDateRanges = ['', '7_days', '30_days', '90_days', 'no_expiry'];
    if (dateRange && !validDateRanges.includes(dateRange)) {
        errors.push('Invalid date range value');
    }
    
    return errors;
}

// Function to update active filters display
function updateActiveFiltersDisplay(status, search, priceRange, quantityStatus, dateRange) {
    const activeFiltersContainer = document.getElementById('active-filters');
    const filters = [];
    
    if (status) {
        const statusLabels = {
            'active': 'Active',
            'expired': 'Expired',
            'expiring_soon': 'Expiring Soon',
            'pending_expiry_date': 'Pending Expiry Date'
        };
        filters.push(`Status: ${statusLabels[status] || status}`);
    }
    
    if (search) {
        filters.push(`Search: "${search}"`);
    }
    
    if (priceRange) {
        const priceLabels = {
            'cost_under_50': 'Cost: Under £50',
            'cost_50_100': 'Cost: £50 - £100',
            'cost_over_100': 'Cost: Over £100',
            'selling_under_50': 'Selling: Under £50',
            'selling_50_100': 'Selling: £50 - £100',
            'selling_over_100': 'Selling: Over £100'
        };
        filters.push(`Price: ${priceLabels[priceRange] || priceRange}`);
    }
    
    if (quantityStatus) {
        const quantityLabels = {
            'low_stock': 'Low Stock (< 10)',
            'out_of_stock': 'Out of Stock (0)',
            'well_stocked': 'Well Stocked (≥ 10)'
        };
        filters.push(`Stock: ${quantityLabels[quantityStatus] || quantityStatus}`);
    }
    
    if (dateRange) {
        const dateLabels = {
            '7_days': 'Expires in 7 days',
            '30_days': 'Expires in 30 days',
            '90_days': 'Expires in 90 days',
            'no_expiry': 'No expiry date'
        };
        filters.push(`Date: ${dateLabels[dateRange] || dateRange}`);
    }
    
    if (filters.length > 0) {
        activeFiltersContainer.innerHTML = filters.map(filter => 
            `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                ${filter}
                <button onclick="clearFilter('${filter.split(':')[0].toLowerCase().trim()}')" class="ml-2 text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>`
        ).join('');
        activeFiltersContainer.style.display = 'flex';
    } else {
        activeFiltersContainer.style.display = 'none';
    }
}

// Function to clear specific filter
function clearFilter(filterType) {
    switch (filterType) {
        case 'status':
            document.getElementById('status').value = '';
            break;
        case 'search':
            document.getElementById('search').value = '';
            break;
        case 'price':
            document.getElementById('price_range').value = '';
            break;
        case 'stock':
            document.getElementById('quantity_status').value = '';
            break;
        case 'date':
            document.getElementById('date_range').value = '';
            break;
    }
    applyFilters();
}

// Function to clear all filters
function clearAllFilters() {
    document.getElementById('status').value = '';
    document.getElementById('search').value = '';
    document.getElementById('price_range').value = '';
    document.getElementById('quantity_status').value = '';
    document.getElementById('date_range').value = '';
    document.getElementById('active-filters').style.display = 'none';
    applyFilters();
}

// Function to update the items table
function updateItemsTable(items) {
    const tbody = document.querySelector('tbody');
    
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">No items found.</td></tr>';
        return;
    }
    
    tbody.innerHTML = '';
    
    items.forEach(item => {
        addItemToTable(item);
    });
    
    // Re-attach event listeners for edit and delete buttons
    // Event delegation is now handled by the document click listener
}

function toggleBulkDelete() {
    console.log('[DEBUG] toggleBulkDelete called');
    isBulkDeleteMode = !isBulkDeleteMode;
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const cancelBulkDeleteBtn = document.getElementById('cancelBulkDeleteBtn');
    const selectAllCheckbox = document.getElementById('selectAll');
    const originalButtons = document.querySelectorAll('.original-button');
    
    if (isBulkDeleteMode) {
        bulkDeleteBtn.style.display = 'none'; // Hide Bulk Delete button
        checkboxes.forEach(checkbox => checkbox.style.display = 'block');
        deleteSelectedBtn.style.display = 'inline-block';
        cancelBulkDeleteBtn.style.display = 'inline-block';
        selectAllCheckbox.style.display = 'block';
        // Hide original buttons
        originalButtons.forEach(button => button.style.display = 'none');
    } else {
        bulkDeleteBtn.style.display = 'inline-block'; // Show Bulk Delete button
        checkboxes.forEach(checkbox => {
            checkbox.style.display = 'none';
            checkbox.checked = false;
        });
        deleteSelectedBtn.style.display = 'none';
        cancelBulkDeleteBtn.style.display = 'none';
        selectAllCheckbox.style.display = 'none';
        selectAllCheckbox.checked = false;
        // Show original buttons
        originalButtons.forEach(button => button.style.display = 'inline-block');
    }
}

function cancelBulkDelete() {
    isBulkDeleteMode = false;
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const cancelBulkDeleteBtn = document.getElementById('cancelBulkDeleteBtn');
    const selectAllCheckbox = document.getElementById('selectAll');
    const originalButtons = document.querySelectorAll('.original-button');
    
    bulkDeleteBtn.style.display = 'inline-block'; // Show Bulk Delete button
    checkboxes.forEach(checkbox => {
        checkbox.style.display = 'none';
        checkbox.checked = false;
    });
    deleteSelectedBtn.style.display = 'none';
    cancelBulkDeleteBtn.style.display = 'none';
    selectAllCheckbox.style.display = 'none';
    selectAllCheckbox.checked = false;
    // Show original buttons
    originalButtons.forEach(button => button.style.display = 'inline-block');
}

async function deleteSelectedItems() {
    if (!isBulkDeleteMode) return;
    
    const selectedItems = Array.from(document.querySelectorAll('.item-checkbox:checked'))
        .map(checkbox => parseInt(checkbox.value));
    
    if (selectedItems.length === 0) {
        showWarningNotification('Please select at least one item to delete');
        return;
    }
    
    try {
        // Get details of all selected items
        const itemDetails = [];
        for (const itemId of selectedItems) {
            const response = await fetch(`/api/v1/items/${itemId}`);
            if (!response.ok) {
                throw new Error(`Failed to get details for item ${itemId}`);
            }
            const result = await response.json();
            itemDetails.push(result.item);
        }
        
        // Show modern confirmation modal with item details
        showBulkDeleteConfirmationModal(itemDetails);
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification(error.message || 'An error occurred while loading item details');
        // Reset bulk delete mode
        cancelBulkDelete();
    }
}

// Add delegation for edit and delete buttons
// This is now handled inside DOMContentLoaded event

async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const feedback = document.getElementById('uploadFeedback');
    const button = document.getElementById('uploadBtn');
    const originalButtonContent = button.innerHTML;
    
    try {
        // Show loading state
        button.innerHTML = `
            <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing...
        `;
        button.disabled = true;
        feedback.classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch('/api/v1/date_ocr/extract', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to process image');
        }
        
        if (data.date) {
            const expiryDateInput = document.getElementById('expiry_date');
            // Ensure we only set the date part (YYYY-MM-DD) to the input
            const dateOnly = data.date.split('T')[0];
            expiryDateInput.value = dateOnly;
            // Trigger change event to update any dependent validation
            expiryDateInput.dispatchEvent(new Event('change'));
            feedback.innerHTML = '<p class="text-green-500">Date extracted successfully!</p>';
        } else {
            feedback.innerHTML = '<p class="text-yellow-500">No date found in image. Please enter manually.</p>';
        }
    } catch (error) {
        console.error('Error processing image:', error);
        feedback.innerHTML = `<p class="text-red-500">${error.message}</p>`;
    } finally {
        // Restore button state
        button.innerHTML = originalButtonContent;
        button.disabled = false;
        
        // Hide feedback after 5 seconds
        setTimeout(() => {
            feedback.classList.add('hidden');
        }, 5000);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Add this after your existing script tags
document.getElementById('uploadBtn').addEventListener('click', function() {
    document.getElementById('dateImageInput').click();
});

// Add event listener for edit form upload button
document.getElementById('editUploadBtn').addEventListener('click', function() {
    document.getElementById('editDateImageInput').click();
});

// Add handler for edit form image upload
async function handleEditImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const feedback = document.getElementById('editUploadFeedback');
    const button = document.getElementById('editUploadBtn');
    const originalButtonContent = button.innerHTML;
    
    try {
        // Show loading state
        button.innerHTML = `
            <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing...
        `;
        button.disabled = true;
        feedback.classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch('/api/v1/date_ocr/extract', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to process image');
        }
        
        if (data.date) {
            const expiryDateInput = document.getElementById('editExpiryDate');
            // Ensure we only set the date part (YYYY-MM-DD) to the input
            const dateOnly = data.date.split('T')[0];
            expiryDateInput.value = dateOnly;
            // Trigger change event to update any dependent validation
            expiryDateInput.dispatchEvent(new Event('change'));
            feedback.innerHTML = '<p class="text-green-500">Date extracted successfully!</p>';
        } else {
            feedback.innerHTML = '<p class="text-yellow-500">No date found in image. Please enter manually.</p>';
        }
    } catch (error) {
        console.error('Error processing image:', error);
        feedback.innerHTML = `<p class="text-red-500">${error.message}</p>`;
    } finally {
        // Restore button state
        button.innerHTML = originalButtonContent;
        button.disabled = false;
        
        // Hide feedback after 5 seconds
        setTimeout(() => {
            feedback.classList.add('hidden');
        }, 5000);
    }
}

function sortTable(columnIndex) {
    // Map column index to sort field
    const sortFieldMap = {
        1: 'name',
        2: 'quantity', 
        4: 'cost_price',
        5: 'selling_price',
        6: 'expiry_date',
        7: 'status'
    };
    
    const sortField = sortFieldMap[columnIndex];
    if (!sortField) return;
    
    // Update sort direction
    if (currentSort.column === columnIndex) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = columnIndex;
        currentSort.direction = 'asc';
    }
    
    // Update sort icons
    document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '↕');
    const currentIcon = document.querySelector(`th:nth-child(${columnIndex + 1}) .sort-icon`);
    currentIcon.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
    
    // Apply sorting using API with all current filters
    const status = document.getElementById('status').value;
    const search = document.getElementById('search').value;
    const priceRange = document.getElementById('price_range').value;
    const quantityStatus = document.getElementById('quantity_status').value;
    const dateRange = document.getElementById('date_range').value;
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Build query parameters
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (search) params.append('search', search);
    if (priceRange) params.append('price_range', priceRange);
    if (quantityStatus) params.append('quantity_status', quantityStatus);
    if (dateRange) params.append('date_range', dateRange);
    params.append('sort_by', sortField);
    params.append('sort_order', currentSort.direction);
    
    // Show loading state
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';
    
    fetch(`/api/v1/items/filter?${params.toString()}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(items => {
        updateItemsTable(items);
    })
    .catch(error => {
        console.error('Error sorting items:', error);
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-red-500">Error sorting items. Please try again.</td></tr>';
    });
        }
        
// Function to attach event listeners to edit and delete buttons
// This function is no longer needed as we use event delegation

// Function to close the add item modal
function closeAddModal() {
    const addModal = document.getElementById('addItemModal');
    if (addModal) {
        addModal.classList.add('hidden');
    }
    
    // Reset the form
    const addForm = document.getElementById('addItemForm');
    if (addForm) {
        addForm.reset();
        
        // Clear any validation errors
        const errorElements = addForm.querySelectorAll('.validation-error');
        errorElements.forEach(error => {
            error.style.display = 'none';
        });
        
        // Reset input styling
        const inputs = addForm.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            input.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
        });
    }
    
    // Clear upload feedback
    const uploadFeedback = document.getElementById('uploadFeedback');
    if (uploadFeedback) {
        uploadFeedback.classList.add('hidden');
        uploadFeedback.innerHTML = '';
    }
}

// Function to close the edit item modal
function closeEditModal() {
    const editModal = document.getElementById('editItemModal');
    if (editModal) {
        editModal.classList.add('hidden');
    }
    
    // Reset the form
    const editForm = document.getElementById('editItemForm');
    if (editForm) {
        editForm.reset();
        
        // Clear any validation errors
        const errorElements = editForm.querySelectorAll('.validation-error');
        errorElements.forEach(error => {
            error.style.display = 'none';
        });
        
        // Reset input styling
        const inputs = editForm.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            input.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
        });
    }
    
    // Clear upload feedback if it exists
    const editUploadFeedback = document.getElementById('editUploadFeedback');
    if (editUploadFeedback) {
        editUploadFeedback.classList.add('hidden');
        editUploadFeedback.innerHTML = '';
    }
    
    // Hide status message
    const statusMessage = document.getElementById('editStatusMessage');
    if (statusMessage) {
        statusMessage.classList.add('hidden');
    }
    
    // Hide discounted price container
    const discountedPriceContainer = document.getElementById('editDiscountedPriceContainer');
    if (discountedPriceContainer) {
        discountedPriceContainer.classList.add('hidden');
    }
}

// Item update confirmation modal functions
function showItemUpdateConfirmationModal(existingItem, newItemData) {
    // Hide the add item modal first
    const addModal = document.getElementById('addItemModal');
    if (addModal) {
        addModal.classList.add('hidden');
    }
    
    const modal = document.getElementById('itemUpdateConfirmationModal');
    const title = document.getElementById('itemUpdateModalTitle');
    const message = document.getElementById('itemUpdateModalMessage');
    const details = document.getElementById('itemUpdateModalDetails');
    const confirmBtn = document.getElementById('confirmUpdateBtn');
    
    // Set modal content
    title.textContent = `Update "${existingItem.name}"`;
    message.textContent = `An item named "${existingItem.name}" already exists in your inventory.`;
    
    // Create comparison details
    const expiryDate = existingItem.expiry_date ? new Date(existingItem.expiry_date).toLocaleDateString() : 'Not set';
    details.innerHTML = `
        <div class="space-y-3">
            <div class="font-medium text-gray-900">Current Item Details:</div>
            <div class="text-sm text-gray-600 space-y-1">
                <div><strong>Quantity:</strong> ${existingItem.quantity} ${existingItem.unit}</div>
                <div><strong>Cost Price:</strong> £${existingItem.cost_price.toFixed(2)}</div>
                <div><strong>Selling Price:</strong> £${existingItem.selling_price.toFixed(2)}</div>
                <div><strong>Expiry Date:</strong> ${expiryDate}</div>
                ${existingItem.description ? `<div><strong>Description:</strong> ${existingItem.description}</div>` : ''}
            </div>
            <div class="border-t pt-2 mt-2">
                <div class="font-medium text-blue-900">New Information:</div>
                <div class="text-sm text-blue-600 space-y-1">
                    <div><strong>Quantity:</strong> ${newItemData.quantity} ${newItemData.unit}</div>
                    <div><strong>Cost Price:</strong> £${newItemData.cost_price.toFixed(2)}</div>
                    <div><strong>Selling Price:</strong> £${newItemData.selling_price.toFixed(2)}</div>
                    <div><strong>Expiry Date:</strong> ${newItemData.expiry_date ? new Date(newItemData.expiry_date).toLocaleDateString() : 'Not set'}</div>
                    ${newItemData.description ? `<div><strong>Description:</strong> ${newItemData.description}</div>` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Set up confirm button action
    confirmBtn.onclick = () => {
        // Hide the confirmation modal without restoring the add modal
        const modal = document.getElementById('itemUpdateConfirmationModal');
        modal.classList.add('hidden');
        
        // Perform the update
        performItemUpdate(existingItem.id, newItemData);
    };
    
    // Show modal
    modal.classList.remove('hidden');
}

function hideItemUpdateConfirmationModal() {
    const modal = document.getElementById('itemUpdateConfirmationModal');
    modal.classList.add('hidden');
    
    // Restore the add item modal since the user might want to try again
    const addModal = document.getElementById('addItemModal');
    if (addModal) {
        addModal.classList.remove('hidden');
    }
}

// Function to perform the actual item update
async function performItemUpdate(itemId, itemData) {
    try {
        const updateResponse = await fetch(`/api/v1/items/${itemId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(itemData)
        });
        
        if (updateResponse.ok) {
            const result = await updateResponse.json();
            showSuccessNotification(result.message || 'Item updated successfully!');
            updateItemInTable(result.item);
            
            // Reset the add form without showing the modal again
            const addForm = document.getElementById('addItemForm');
            if (addForm) {
                addForm.reset();
                
                // Clear any validation errors
                const errorElements = addForm.querySelectorAll('.validation-error');
                errorElements.forEach(error => {
                    error.style.display = 'none';
                });
                
                // Reset input styling
                const inputs = addForm.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    input.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
                });
            }
            
            // Clear upload feedback
            const uploadFeedback = document.getElementById('uploadFeedback');
            if (uploadFeedback) {
                uploadFeedback.classList.add('hidden');
                uploadFeedback.innerHTML = '';
            }
            
            // Ensure add modal stays hidden
            const addModal = document.getElementById('addItemModal');
            if (addModal) {
                addModal.classList.add('hidden');
            }
        } else {
            const errorData = await updateResponse.json();
            throw new Error(errorData.error || 'Failed to update item');
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorNotification(error.message || 'Failed to update item');
    }
}

// Function to close the add item modal
</script>
{% endblock %} 